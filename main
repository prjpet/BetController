#USER VARIABLES
betOptions = "unkown"   #
EndTime = "45"      #Last minute that is permiteted to bet
StartTime = "10"    #First minute that is permited to bet
MinValOdd = "1.2"    #Minimum value for the odd that is permited to bet
minDelay = 4          #Minumum time delay in seconds
MaxDelay = 10         #Maximum time delay in seconds

from LoadBrowser import LoadBrowser
from Game import Game
import random, time, pyautogui

import io


# When fail-safe mode is True, moving the mouse to the upper-left will raise a pyautogui.FailSafeException that can abort your program:
pyautogui.FAILSAFE = True
a = random.uniform(minDelay, MaxDelay)  # example of Random time delay



if __name__ == "__main__":


    LoadBrowser = LoadBrowser()
    #1. PREPARE WEBSITE:
    # - Click through the correct links until on the correct page (Overview - Soccer)
    # missing: delay between interaction
    LoadBrowser.locateElementByTextAndClick("English")
    LoadBrowser.locateElementByTextAndClick("In-Play")
    LoadBrowser.DRIVER.find_elements_by_class_name("hm-DropDownSelections_Highlight ")[1].click()
    LoadBrowser.locateElementByTextAndClick("Decimal")


    #2. LOGIN

    #LoadOdds.locateUsernameAndPassword("input.hm-Login_InputField", "username","password")
    #LoadOdds.locateElementByCssAndClick("button.hm-Login_LoginBtn")


    #3. CLICK "Event View"
    LoadBrowser.locateElementByXpathAndClick("//span/div[2]")

    # 4. LOAD GAME DATA:
    # missing: score, betOptions, nameOfOdds, odds
    teamList = LoadBrowser.locateElementsByClassAndLoad("ipn-TeamStack_Team")
    timeList = LoadBrowser.locateElementsByClassAndLoad("ipn-ScoreDisplayStandard_Timer")
    scoreList= LoadBrowser.locateElementsByClassAndLoad("ipn-ScoreDisplayStandard_Score")

    #CHANGE: 03/06/2017 - RENAMED "buttons" to "originalGames"
    originalGames = LoadBrowser.locateElementsByClassAndLoad("ipn-FixtureButton ")# - THIS LOADS ALL GAMES ON PAGE WITH SCORES AND CURRENT TIME ans score




    first_run=False
    old_moveToY =225
    numberElement = 0

    #

    for item in originalGames:
        Odd05="NONE"
        OverGoals="NONE"
        Bet_ON="FALSE"
        FHG_list=[]
        #CHANGE: 03/06/2017 - NEED to check whether the original games are the same as the available games,
        #                     because the code will break if the game list changed
        #                     and you try to click on the game which is not there anymore.

        availableGames = LoadBrowser.locateElementsByClassAndLoad("ipn-FixtureButton ")


        moveToX = item.location_once_scrolled_into_view['x'] + 100
        moveToY = item.location_once_scrolled_into_view['y'] + 100
        Team1 = item.text.split("\n")[0]
        Team2 = item.text.split("\n")[1]
        Score = item.text.split("\n")[2]
        GameTime = item.text.split("\n")[3]
        #print(item.text.split("\n"))
        #print("mote to X: ",moveToX)
        #print("mote to Y: ",moveToY)
        #print("Item size: ", item.size)

        if first_run==False: # move cursor at the starting point------------------------------------------------------------------------
            pyautogui.hotkey('alt', 'space')
            pyautogui.hotkey('x')
            pyautogui.moveTo(moveToX, moveToY, duration=0.5)
        first_run=True

        scrool_val=(moveToY-old_moveToY)
        #print("Scrool value: ",scrool_val)
        pyautogui.scroll(-scrool_val)
        old_moveToY = moveToY
        pyautogui.click(button='left')  # right-click the mouse


        # LOOF FOR FIRST HALF GOALS

        SEARCH_STRING1 = "First Half Goals"
        SEARCH_STRING2 = "Over"
        # LoadBrowser.locateElementByAndLoad("//div[@class='fc-day-content' and text()='15']")
        # buto_test=LoadBrowser.locateElementsByClassAndLoad("gl-MarketGroupButton_Text") - working
        buto_test = LoadBrowser.locateElementsByClassAndLoad("gl-MarketGroup")
        for i, item in enumerate(buto_test):
            #print(i,": " + item.text)
            startIndex = len(SEARCH_STRING1)

            if item.text.find(SEARCH_STRING1) != -1:  # "First Half Goals": - WORKING
                FHG_list = item.text.split("\n")
                #check if Over value is a float value- error in case that odds are blocked/modified
                if FHG_list[FHG_list.index("Over") + 1] !="Under":
                    Odd05 = FHG_list[FHG_list.index("Over") + 1]
                    OverGoals=(FHG_list[1])
                    #print(Odd05)

            #Validate for bet_on
        if Score =="0-0" and StartTime < GameTime[:2] and EndTime > GameTime[:2] and MinValOdd<Odd05 and OverGoals=="0.5":
            Bet_ON="TRUE"

            # element_list with: CURRENT TIME.....TEAM 1.....TEAM 2.....SCORE.....TIME OF THE GAME.....OVER GOALS....ODD OVER.....BET ON.....WINNER
        element_list=(Team1+","+Team2+","+Score+","+GameTime+","+OverGoals+","+Odd05,","+Bet_ON)
        print(element_list)




       #WAYS TO DEAL WITH ERROR ->    http://engineeringquality.blogspot.co.uk/2013/08/ways-of-dealing-with.html



                #using a generator function go through every second element in the list, and also grab i to be the index of correct element, not standard increment
   # for i in range(0, min(len(teamList),len(timeList),len(scoreList))):

        #THEN append a game with time: T1 ----------------- T2 --------------- TIME ------------ SCORE -----
       # availableGames.append(Game(teamList[i*2].text, teamList[i*2+1].text, timeList[i].text, scoreList[i].text))

    #DISPLAY ALL REGISTERED GAMES
    #for i, item in enumerate(availableGames):

        #if i==0:
        #LoadBrowser.locateElementByTextAndClick(buttons[i].text[1:buttons[i].text.find("-")-1])
        #else:
        #LoadBrowser.locateElementByXpathAndClick("//div["+str(i+1)+"]/div/div[2]/div[2]")

        #LoadBrowser.locateElementByClassAndClick("ipn - FixtureButton ")
        #LoadBrowser.locateElementByClassAndClick( "ipn-Fixture ipn-Fixture_HasTeamStack ipn-Fixture-closed ipn-Fixture-selected ipn-Fixture-hastimer ")
        #LoadBrowser.locateElementByClassAndClick("ipn - FixtureButton_OpenIcon")
        #LoadBrowser.locateElementByClassAndClick("ipn - TeamStack")


        #LoadBrowser.locateElementByCssAndClick("ipn - FixtureButton ")
        #LoadBrowser.locateElementByCssAndClick( "ipn-Fixture ipn-Fixture_HasTeamStack ipn-Fixture-closed ipn-Fixture-selected ipn-Fixture-hastimer ")
        #LoadBrowser.locateElementByCssAndClick("ipn - FixtureButton_OpenIcon")
        #LoadBrowser.locateElementByCssAndClick("ipn - TeamStack")


        #time.sleep(1)  # delays for 5 seconds
        #print ("random time delay in seconds : ", a, " and i is:", i )

# GUI

#pyautogui.hotkey('alt', 'space')
#pyautogui.hotkey('x')
#pyautogui.moveTo(300, 300, duration=2)







"""
User Variables:
betOptions, EndTime, StartTime, MinValOdd, minDelay, MaxDelay

Game properties:
BetTRUE, Team1, team2, time, score, betOptions, (nameOfOdds, odds)

-1. DEFINE selected bet options - get proper string name into variable
0-load ALL GAMES
1-first game - Team1, team2, time, score, betOptions, (nameOfOdds, odds)
2 if score is different from 0:0 OR
    time is not in interval StartTime, EndTime OR
    the betOptions (1st half score or 2nd half score) doesn't exist THEN 
    click on next game 
3 else read the (nameOfOdds, odds) value for bet option
4.if odds values are bigger then MinValOdd(1.41) AND
BetTRUE=FALSE
then  BetTRUE - output the game + minute + score + odds value into a txt file

if score is different from 0:0 AND
betOptions is == 2nd half score AND
odds values are bigger then MinValOdd AND
betTRUE ==FALSE
then  BetTRUE - output the game + minute + score + odds value into a txt file

-UPDATE GAME LIST (what is the update frequency???)
-TRY TO ADD FINAL SCORE 

ADD ramdom delays in seconds between actions (minDelay and MaxDelay)
"""